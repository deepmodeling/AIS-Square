# IR spectrum calculation workflow
## Introduction
This is a workflow of the IR spectrum calculation. It uses Deep Wannier model to calculate the dipole, and generate the IR spectra by the fourier transform of the correlation function:

$n(\omega)\alpha(\omega) = \frac{2\pi\beta}{3cV}\int_{-\infty}^{+\infty}\mathrm{d}t e^{-i\omega t}\langle\dot{M}(0)\cdot\dot{M}(t)\rangle$

This workflow supports dipole calculations both on Qe-PW+Wannier90 and Qe-CP. In the future, we may also support VASP/ABUCAS+Wannier90. MD sampling supports deepmd+lammps. 

## Details of the workflow
This workflow contains 4 modules: wannier centroid(WC), deep wannier(DW), sampling, and IR. ![workflow](./workflow.jpg)

The WC module calculates the wannier centroid and outputs the labeled system to DW module. DW module will train the deep wannier model. Sampling module will sample from MD trajectory generated by DeepMD+Lammps and compute the dipole by DW model. Finally IR module will calculate the correlation function from the sampled dipole data and generate the IR spectra by fourier transform.

To use this workflow, you need prepare the dp model, the input system, and some json files to set the parameters. The configurations data to train DW is optional, and you can provide the configurations for DP model, such as the dataset generated by dpgen. If configurations are not provided, it can be sampled from MD by the provided dp model.

### WC module
WC module contains 2 `SuperOP`s and 4 `OP`s:
![DipoleSteps](./DipoleSteps.jpg)

-------------------

**Name**: `DipoleSteps`  

**Type**: SuperOP

**Discription**:  
Calculate the wannier centroid from the given configurations. It supports Qe-PW+Wannier90 and Qe-CP. The default WC only supports H2O, and user can implement `CalWC` OP to define their WC.

**OP**:  
This SuperOP uses 2 OPs: `MLWFSteps` and `CalWC`.

-------------------

**Name**: `MLWFSteps`  

**Type**: SuperOP

**Discription**:  
Calculate the wannier function centers from the given configurations. It supports Qe-PW+Wannier90 and Qe-CP.

**OP**:  
This SuperOP uses 3 OPs: `Prepare`, `RunMLWF`, and `CollectWFC`. 

-------------------

**Name**: `Prepare`  

**Type**: OP

**Discription**:  
This OP generates the inputs from the template and puts them into subpaths. 

**Implementation**:  
There are 2 implementations: `PrepareQeWann` and `PrepareCP`.

`PrepareQeWann` prepare the inputs for Qe-PW and Wannier90;

`PrepareCP` prepare the inputs for Qe-CP.

-------------------

**Name**: `RunMLWF`  

**Type**: OP

**Discription**:  
This OP runs dft packages to calculate the wannier function centers.

**Implementation**:  
There are 2 implementations: `RunQeWann` and `RunCPWF`.

`RunQeWann` run Qe-PW and Wannier90;

`RunCPWF` run the "cp-wf" calculation of Qe-CP.

-------------------

**Name**: `CollectWFC`  

**Type**: OP

**Discription**:  
This OP collects the wannier function centers generated by `RunMLWF`.

**Implementation**:  
There are 2 implementations: `CollectWann` and `CollectCPWF`.

`CollectWann` collect data in `{name}_centres.xyz` generated by Wannier90;

`CollectCPWF` collect data in `{prefix}.wfc` generated by Qe cp-wf.

-------------------

**Name**: `CalWC`  

**Type**: OP

**Discription**:  
This OP calculate the wannier centroid from WFC generated by `MLWFSteps`.

**Implementation**:  
There is 1 implementation: `CalWC`.
It only supports calculate WC for H2O.  
User can inherit this OP to define and calculate the WC to suit their needs.